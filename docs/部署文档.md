# MySQL数据同步插件 - 部署文档

## 📋 项目概述

这是一个用于钉钉AI表格的MySQL数据源同步插件,支持将企业内部MySQL数据库的数据同步到AI表格中。

### 技术栈
- **后端**: Go 1.21 + Gin框架
- **前端**: React 18 + TypeScript + Vite + Ant Design
- **数据库**: MySQL 5.7+

## 🚀 快速开始

### 一、后端部署

#### 1. 环境准备

```bash
# 确保已安装Go 1.21+
go version

# 进入后端目录
cd backend
```

#### 2. 安装依赖

```bash
# 初始化Go模块并下载依赖
go mod download
```

#### 3. 配置环境变量

```bash
# 复制环境变量模板
cp .env.example .env

# 编辑 .env 文件,填写配置
nano .env
```

`.env` 配置示例:
```bash
SERVER_PORT=8080
SECRET_KEY=your-secret-key-from-dingtalk
DEBUG=false
```

> ⚠️ **重要**: `SECRET_KEY` 需要与钉钉开放平台约定,用于签名验证

#### 4. 编译运行

**开发环境运行:**
```bash
go run main.go
```

**生产环境编译:**
```bash
# Linux/MacOS
go build -o mysql-sync-server main.go

# Windows
go build -o mysql-sync-server.exe main.go

# 运行
./mysql-sync-server
```

#### 5. 使用Docker部署(推荐)

创建 `Dockerfile`:
```dockerfile
FROM golang:1.21-alpine AS builder

WORKDIR /app
COPY go.mod go.sum ./
RUN go mod download

COPY . .
RUN CGO_ENABLED=0 GOOS=linux go build -o mysql-sync-server main.go

FROM alpine:latest
RUN apk --no-cache add ca-certificates

WORKDIR /root/
COPY --from=builder /app/mysql-sync-server .

EXPOSE 8080
CMD ["./mysql-sync-server"]
```

构建并运行:
```bash
# 构建镜像
docker build -t mysql-sync-plugin:latest .

# 运行容器
docker run -d \
  -p 8080:8080 \
  -e SERVER_PORT=8080 \
  -e SECRET_KEY=your-secret-key \
  --name mysql-sync \
  mysql-sync-plugin:latest
```

---

### 二、前端部署

#### 1. 安装依赖

```bash
cd frontend
npm install
```

#### 2. 配置环境变量

```bash
# 复制环境变量模板
cp .env.example .env

# 编辑配置
nano .env
```

`.env` 配置示例:
```bash
# 开发环境
VITE_API_BASE_URL=http://localhost:8080

# 生产环境
VITE_API_BASE_URL=https://your-backend-domain.com
```

#### 3. 开发运行

```bash
npm run dev
```

访问: http://localhost:3000

#### 4. 生产构建

```bash
# 构建静态文件
npm run build

# 构建产物在 dist/ 目录
```

#### 5. 部署到Nginx

将 `dist/` 目录内容部署到Nginx:

**Nginx配置示例** (`/etc/nginx/sites-available/mysql-sync`):
```nginx
server {
    listen 80;
    server_name your-frontend-domain.com;

    # 强制HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-frontend-domain.com;

    ssl_certificate /path/to/ssl/cert.pem;
    ssl_certificate_key /path/to/ssl/key.pem;

    root /var/www/mysql-sync-frontend;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    # 反向代理API请求到后端
    location /api {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

启用配置:
```bash
sudo ln -s /etc/nginx/sites-available/mysql-sync /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

---

## 🔧 钉钉开放平台配置

### 1. 创建酷应用

1. 登录 [钉钉开放平台](https://open-dev.dingtalk.com/)
2. 创建企业内部应用
3. 在应用管理中添加酷应用
4. 选择"AI表格数据源插件"类型

### 2. 配置Manifest

在酷应用配置中上传 `manifest.json` 文件:

```json
{
  "dataSource": {
    "dataSourceConfig": {
      "uri": "https://your-frontend-domain.com?corpId=$CORPID$",
      "initHeight": 500,
      "initWidth": 600
    },
    "uris": [
      {
        "method": "sheetMeta",
        "uri": "/api/sheet_meta"
      },
      {
        "method": "records",
        "uri": "/api/records"
      }
    ]
  }
}
```

> 注意: `uri` 字段中的 `$CORPID$` 会被AI表格自动替换为当前组织ID

### 3. 配置签名密钥

1. 在钉钉开放平台生成或设置 `SECRET_KEY`
2. 将该密钥配置到后端环境变量中
3. 确保前后端使用相同的密钥进行签名验证

### 4. 发布应用

根据开发指南中的流程:
1. 完成免费规格商品开通
2. 申请不展示开放平台入口
3. 去掉开通通知
4. 联系钉钉负责人完成审批

---

## 📊 API接口说明

### 后端提供的接口

#### 1. 健康检查
```
GET /health
```

#### 2. 获取数据表列表(前端配置用)
```
POST /api/tables
请求体: {
  "host": "127.0.0.1",
  "port": 3306,
  "username": "root",
  "password": "password",
  "database": "test_db"
}
```

#### 3. 获取表字段(前端配置用)
```
POST /api/fields
请求体: {
  "host": "127.0.0.1",
  "port": 3306,
  "username": "root",
  "password": "password",
  "database": "test_db",
  "table": "users"
}
```

#### 4. 获取表结构(AI表格调用,需签名)
```
POST /api/sheet_meta
请求头:
  - Ding-Docs-Timestamp
  - Ding-Docs-Signature
```

#### 5. 获取表记录(AI表格调用,需签名)
```
POST /api/records
请求头:
  - Ding-Docs-Timestamp
  - Ding-Docs-Signature
```

---

## 🔐 安全注意事项

### 1. HTTPS要求
- 前端页面**必须**使用HTTPS部署
- 钉钉要求所有酷应用必须通过HTTPS访问

### 2. 网络访问
- 后端服务需要能够访问企业内部MySQL数据库
- 如果MySQL在内网,建议后端也部署在内网并配置反向代理

### 3. 凭证保护
- 不要在前端代码中硬编码数据库密码
- 使用环境变量管理敏感信息
- 定期更换SECRET_KEY

### 4. MySQL权限
建议为插件创建专用只读账户:
```sql
CREATE USER 'dingtalk_sync'@'%' IDENTIFIED BY 'strong_password';
GRANT SELECT ON your_database.* TO 'dingtalk_sync'@'%';
FLUSH PRIVILEGES;
```

---

## 🧪 测试验证

### 1. 后端测试

```bash
# 健康检查
curl http://localhost:8080/health

# 测试获取表列表
curl -X POST http://localhost:8080/api/tables \
  -H "Content-Type: application/json" \
  -d '{
    "host": "127.0.0.1",
    "port": 3306,
    "username": "root",
    "password": "password",
    "database": "test_db"
  }'
```

### 2. 前端测试

1. 访问前端页面
2. 填写MySQL连接信息
3. 依次完成:连接数据库 → 选择表 → 选择字段
4. 检查浏览器控制台是否有错误

### 3. 端到端测试

1. 在钉钉AI表格中打开数据源同步
2. 选择MySQL插件
3. 完成授权和配置
4. 验证数据是否正确同步

---

## 🐛 常见问题

### 1. 后端编译错误

**问题**: `could not import github.com/go-sql-driver/mysql`

**解决**:
```bash
cd backend
go mod tidy
go mod download
```

### 2. 前端连接后端失败

**检查**:
- 后端是否正常启动
- CORS配置是否正确
- 环境变量中的API地址是否正确

### 3. 签名验证失败

**原因**:
- SECRET_KEY配置不一致
- 请求时间戳过期
- 请求体被修改

**解决**: 检查后端日志,确认SECRET_KEY配置正确

### 4. MySQL连接失败

**检查**:
- MySQL服务是否运行
- 网络是否可达
- 用户名密码是否正确
- MySQL用户权限是否足够

---

## 📝 项目结构

```
mysql-sync-plugin/
├── backend/                 # Go后端
│   ├── config/             # 配置管理
│   ├── handler/            # HTTP处理器
│   ├── middleware/         # 中间件(签名验证)
│   ├── models/             # 数据模型
│   ├── service/            # 业务逻辑
│   ├── main.go             # 入口文件
│   ├── go.mod              # Go依赖
│   └── .env.example        # 环境变量模板
├── frontend/               # React前端
│   ├── src/
│   │   ├── App.tsx         # 主组件
│   │   ├── api.ts          # API调用
│   │   └── main.tsx        # 入口
│   ├── package.json        # NPM依赖
│   └── .env.example        # 环境变量模板
├── manifest.json           # 钉钉插件配置
└── docs/                   # 文档
    └── deployment.md       # 本文件
```

---

## 📞 联系与支持

遇到问题请检查:
1. 本部署文档
2. [AI表格数据源开发指南](../AI表格数据源%20开发指南.md)
3. [钉钉开放平台文档](https://open.dingtalk.com/)

---

## 🔄 版本更新

### v1.0.0 (2024-01-XX)
- ✅ 支持MySQL数据库连接
- ✅ 支持表结构和记录同步
- ✅ 支持字段类型映射
- ✅ 支持分页拉取数据
- ✅ 实现签名验证机制
