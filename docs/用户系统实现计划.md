# 用户系统实现计划

## 一、需求概述

### 核心需求
1. **多管理员账号管理**：支持多个管理员账号,可以在后台新增、编辑、删除管理员
2. **普通用户系统**：管理员可以创建和管理普通用户账号
3. **用户数据源配置**：为每个用户配置可访问的数据库连接信息和权限范围
4. **数据源权限管理**：
   - 配置用户可访问的数据库列表
   - 配置用户可访问的表列表
   - 配置自定义SQL查询
   - 为数据库、表、字段设置别名
5. **前端傻瓜化**：钉钉和飞书前端只需登录账号,选择预配置的数据源与配置字段映射名即可
6. **数据库抽象层**：当前使用SQLite,预留迁移到MySQL的能力

### 设计原则
- 复用现有认证架构(auth包)
- 遵循现有代码风格和模式
- 数据访问层抽象,便于后续迁移数据库
- 保持向后兼容,不破坏现有功能

## 二、架构设计

### 2.1 数据模型设计

#### 用户表扩展 (users)
```sql
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT UNIQUE NOT NULL,
    password TEXT NOT NULL,
    role TEXT NOT NULL DEFAULT 'user',  -- 'admin' 或 'user'
    display_name TEXT,                   -- 显示名称
    status TEXT NOT NULL DEFAULT 'active', -- 'active' 或 'disabled'
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

#### 数据源配置表 (datasources)
```sql
CREATE TABLE datasources (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,                  -- 数据源名称(用户可见)
    description TEXT,                    -- 数据源描述
    host TEXT NOT NULL,                  -- MySQL主机
    port INTEGER NOT NULL,               -- MySQL端口
    database_name TEXT NOT NULL,         -- 数据库名
    username TEXT NOT NULL,              -- MySQL用户名
    password TEXT NOT NULL,              -- MySQL密码(加密存储)
    created_by INTEGER NOT NULL,         -- 创建者ID
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (created_by) REFERENCES users(id)
);
CREATE INDEX idx_datasources_created_by ON datasources(created_by);
```

#### 数据源表配置 (datasource_tables)
```sql
CREATE TABLE datasource_tables (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    datasource_id INTEGER NOT NULL,      -- 数据源ID
    table_name TEXT NOT NULL,            -- 表名
    table_alias TEXT,                    -- 表别名
    query_mode TEXT NOT NULL DEFAULT 'table', -- 'table' 或 'sql'
    custom_sql TEXT,                     -- 自定义SQL(当query_mode='sql'时)
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (datasource_id) REFERENCES datasources(id) ON DELETE CASCADE,
    UNIQUE(datasource_id, table_name)
);
CREATE INDEX idx_datasource_tables_datasource ON datasource_tables(datasource_id);
```

#### 字段映射表 (field_mappings)
```sql
CREATE TABLE field_mappings (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    datasource_table_id INTEGER NOT NULL, -- 数据源表ID
    field_name TEXT NOT NULL,             -- 原始字段名
    field_alias TEXT NOT NULL,            -- 字段别名
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (datasource_table_id) REFERENCES datasource_tables(id) ON DELETE CASCADE,
    UNIQUE(datasource_table_id, field_name)
);
CREATE INDEX idx_field_mappings_table ON field_mappings(datasource_table_id);
```

#### 用户数据源权限表 (user_datasource_permissions)
```sql
CREATE TABLE user_datasource_permissions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,            -- 用户ID
    datasource_id INTEGER NOT NULL,      -- 数据源ID
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (datasource_id) REFERENCES datasources(id) ON DELETE CASCADE,
    UNIQUE(user_id, datasource_id)
);
CREATE INDEX idx_user_datasource_user ON user_datasource_permissions(user_id);
CREATE INDEX idx_user_datasource_datasource ON user_datasource_permissions(datasource_id);
```

#### 用户表权限表 (user_table_permissions)
```sql
CREATE TABLE user_table_permissions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,            -- 用户ID
    datasource_table_id INTEGER NOT NULL, -- 数据源表ID
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (datasource_table_id) REFERENCES datasource_tables(id) ON DELETE CASCADE,
    UNIQUE(user_id, datasource_table_id)
);
CREATE INDEX idx_user_table_user ON user_table_permissions(user_id);
CREATE INDEX idx_user_table_table ON user_table_permissions(datasource_table_id);
```

### 2.2 数据访问层抽象

#### 接口定义 (backend/repository/interface.go)
```go
// Repository 数据访问接口
type Repository interface {
    // 用户管理
    CreateUser(user *models.User) error
    GetUserByID(id int64) (*models.User, error)
    GetUserByUsername(username string) (*models.User, error)
    ListUsers(query *UserQuery) ([]*models.User, int64, error)
    UpdateUser(user *models.User) error
    DeleteUser(id int64) error

    // 数据源管理
    CreateDatasource(ds *models.Datasource) error
    GetDatasourceByID(id int64) (*models.Datasource, error)
    ListDatasources(query *DatasourceQuery) ([]*models.Datasource, int64, error)
    UpdateDatasource(ds *models.Datasource) error
    DeleteDatasource(id int64) error

    // 数据源表管理
    CreateDatasourceTable(table *models.DatasourceTable) error
    GetDatasourceTableByID(id int64) (*models.DatasourceTable, error)
    ListDatasourceTables(datasourceID int64) ([]*models.DatasourceTable, error)
    UpdateDatasourceTable(table *models.DatasourceTable) error
    DeleteDatasourceTable(id int64) error

    // 字段映射管理
    BatchCreateFieldMappings(tableID int64, mappings []*models.FieldMapping) error
    ListFieldMappings(tableID int64) ([]*models.FieldMapping, error)
    DeleteFieldMappingsByTableID(tableID int64) error

    // 权限管理
    GrantDatasourcePermission(userID, datasourceID int64) error
    RevokeDatasourcePermission(userID, datasourceID int64) error
    ListUserDatasources(userID int64) ([]*models.Datasource, error)

    GrantTablePermission(userID, tableID int64) error
    RevokeTablePermission(userID, tableID int64) error
    ListUserTables(userID, datasourceID int64) ([]*models.DatasourceTable, error)
}
```

### 2.3 后端API设计

#### 用户管理API (需要admin角色)
```
POST   /admin/api/users              创建用户
GET    /admin/api/users              获取用户列表(分页)
GET    /admin/api/users/:id          获取用户详情
PUT    /admin/api/users/:id          更新用户信息
DELETE /admin/api/users/:id          删除用户
PUT    /admin/api/users/:id/status   启用/禁用用户
PUT    /admin/api/users/:id/password 重置用户密码
```

#### 数据源管理API (需要admin角色)
```
POST   /admin/api/datasources           创建数据源
GET    /admin/api/datasources           获取数据源列表
GET    /admin/api/datasources/:id       获取数据源详情
PUT    /admin/api/datasources/:id       更新数据源
DELETE /admin/api/datasources/:id       删除数据源
POST   /admin/api/datasources/:id/test  测试数据源连接
```

#### 数据源表管理API (需要admin角色)
```
POST   /admin/api/datasources/:id/tables        创建表配置
GET    /admin/api/datasources/:id/tables        获取表配置列表
GET    /admin/api/datasource-tables/:id         获取表配置详情
PUT    /admin/api/datasource-tables/:id         更新表配置
DELETE /admin/api/datasource-tables/:id         删除表配置
POST   /admin/api/datasource-tables/:id/fields  批量设置字段映射
GET    /admin/api/datasource-tables/:id/fields  获取字段映射列表
```

#### 权限管理API (需要admin角色)
```
POST   /admin/api/users/:id/datasources         授予数据源权限
DELETE /admin/api/users/:id/datasources/:dsId   撤销数据源权限
GET    /admin/api/users/:id/datasources         获取用户数据源列表

POST   /admin/api/users/:id/tables              授予表权限
DELETE /admin/api/users/:id/tables/:tableId     撤销表权限
GET    /admin/api/users/:id/tables              获取用户表列表
```

#### 前端用户API (钉钉/飞书前端使用)
```
POST   /api/auth/login                  用户登录(返回token)
POST   /api/auth/logout                 用户登出
GET    /api/auth/current                获取当前用户信息

GET    /api/user/datasources            获取当前用户可访问的数据源列表
GET    /api/user/datasources/:id/tables 获取数据源下可访问的表列表
```

#### 修改现有API
钉钉和飞书的 `sheet_meta/table_meta` 和 `records` 接口需要修改:
1. 从请求中提取用户token
2. 验证用户身份和权限
3. 根据用户权限过滤可访问的数据
4. 使用预配置的数据源信息(不再从params解析)

### 2.4 前端设计

#### 管理后台新增页面
- `/admin/users` - 用户管理页面
- `/admin/users/create` - 创建用户页面
- `/admin/users/:id/edit` - 编辑用户页面
- `/admin/datasources` - 数据源管理页面
- `/admin/datasources/create` - 创建数据源页面
- `/admin/datasources/:id` - 数据源详情页面(包含表配置)
- `/admin/permissions` - 权限管理页面

#### 钉钉/飞书前端改造

**原有流程:**
1. 手动输入数据库连接信息
2. 选择数据库
3. 选择表
4. 配置字段映射
5. 保存配置

**新流程:**
1. 登录(输入用户名密码)
2. 选择数据源(下拉列表)
3. 选择表(下拉列表,显示别名)
4. 配置字段映射
5. 点击确认

### 2.5 安全设计

#### 密码加密
- 管理员密码: SHA256(现有方式)
- 普通用户密码: SHA256(保持一致)
- 数据源密码: AES加密存储

#### 权限验证
- 管理后台: 验证admin角色
- 前端API: 验证用户token和数据源权限
- 数据访问: 验证表级权限

#### Token管理
- 管理员token: 24小时过期(现有)
- 普通用户token: 7天过期(长期使用)
- 自动续期机制

## 三、实现步骤

### 阶段一: 数据库层
**预计时间: 2-3天**

**任务清单:**
1. 创建数据库迁移脚本
2. 扩展users表,添加role、display_name、status字段
3. 创建所有新表(datasources、datasource_tables、field_mappings、权限表)
4. 定义Repository接口
5. 实现SQLite Repository
6. 编写单元测试

**文件清单:**
- `backend/repository/interface.go` (新建)
- `backend/repository/sqlite_repo.go` (新建)
- `backend/repository/mysql_repo.go` (新建,预留)
- `backend/repository/repository_test.go` (新建)
- `backend/models/user_models.go` (新建)
- `backend/models/datasource_models.go` (新建)
- `backend/models/permission_models.go` (新建)
- `backend/auth/store.go` (修改,添加role支持)
- `backend/auth/models.go` (修改,User添加Role、DisplayName、Status字段)

### 阶段二: 后端服务层
**预计时间: 3-4天**

**任务清单:**
1. 创建用户管理Service
2. 创建数据源管理Service
3. 创建权限管理Service
4. 实现密码加密/解密工具(AES)
5. 编写业务逻辑测试

**文件清单:**
- `backend/service/user_service.go` (新建)
- `backend/service/datasource_service.go` (新建)
- `backend/service/permission_service.go` (新建)
- `backend/service/crypto_service.go` (新建,AES加密)
- `backend/service/user_service_test.go` (新建)

### 阶段三: 后端API层
**预计时间: 3-4天**

**任务清单:**
1. 创建用户管理Handler
2. 创建数据源管理Handler
3. 创建权限管理Handler
4. 创建前端用户认证Handler
5. 添加角色验证中间件
6. 修改现有API支持用户权限
7. 更新路由配置

**文件清单:**
- `backend/handler/user_handler.go` (新建)
- `backend/handler/datasource_handler.go` (新建)
- `backend/handler/permission_handler.go` (新建)
- `backend/handler/user_auth_handler.go` (新建,前端用户认证)
- `backend/auth/middleware.go` (修改,添加角色验证)
- `backend/handler/handler.go` (修改,支持用户权限)
- `backend/handler/feishu_handler.go` (修改,支持用户权限)
- `backend/main.go` (修改,添加新路由)

### 阶段四: 管理后台前端
**预计时间: 4-5天**

**任务清单:**
1. 创建用户管理页面
   - 用户列表(表格,分页,搜索)
   - 创建用户表单
   - 编辑用户表单
   - 删除确认对话框
2. 创建数据源管理页面
   - 数据源列表
   - 创建数据源表单
   - 编辑数据源表单
   - 测试连接功能
3. 创建表配置页面
   - 表列表(按数据源)
   - 添加表配置
   - 字段映射配置
4. 创建权限管理页面
   - 用户-数据源授权
   - 用户-表授权
   - 权限树形展示
5. 更新导航菜单

**文件清单:**
- `admin-frontend/src/views/Users.vue` (新建)
- `admin-frontend/src/views/UserForm.vue` (新建)
- `admin-frontend/src/views/Datasources.vue` (新建)
- `admin-frontend/src/views/DatasourceForm.vue` (新建)
- `admin-frontend/src/views/DatasourceTables.vue` (新建)
- `admin-frontend/src/views/Permissions.vue` (新建)
- `admin-frontend/src/api/index.ts` (修改,添加新API)
- `admin-frontend/src/router/index.ts` (修改,添加新路由)
- `admin-frontend/src/layouts/MainLayout.vue` (修改,添加菜单项)

### 阶段五: 钉钉/飞书前端改造
**预计时间: 2-3天**

**任务清单:**
1. 添加登录页面
2. 修改配置流程
   - 移除手动输入数据库信息
   - 添加数据源选择器
   - 添加表选择器
   - 保留字段映射
3. 实现token管理
4. 更新API调用逻辑

**文件清单:**
- `frontend-dingtalk/src/views/Login.vue` (新建)
- `frontend-dingtalk/src/views/Config.vue` (修改)
- `frontend-dingtalk/src/api/auth.ts` (新建)
- `frontend-dingtalk/src/stores/auth.ts` (新建)
- `frontend-feishu/src/views/Login.vue` (新建)
- `frontend-feishu/src/views/Config.vue` (修改)
- `frontend-feishu/src/api/auth.ts` (新建)
- `frontend-feishu/src/stores/auth.ts` (新建)

### 阶段六: 测试与优化
**预计时间: 2-3天**

**任务清单:**
1. 集成测试
2. 性能测试
3. 安全测试
4. 用户体验优化
5. 文档更新

## 四、数据迁移方案

### 4.1 现有数据兼容
- 现有admin账号自动标记为admin角色
- 现有sessions表保持不变
- 现有logs表保持不变

### 4.2 SQLite到MySQL迁移准备
1. Repository接口已抽象
2. 数据库连接配置化
3. 提供迁移脚本
4. 数据导出/导入工具

### 4.3 迁移步骤
```bash
# 1. 导出SQLite数据
go run tools/export_sqlite.go

# 2. 创建MySQL数据库
mysql -u root -p < schema/mysql_schema.sql

# 3. 导入数据
go run tools/import_mysql.go

# 4. 切换配置
# 修改 .env 文件
DB_TYPE=mysql
DB_HOST=localhost
DB_PORT=3306
DB_NAME=mysql_sync_plugin
DB_USER=root
DB_PASSWORD=password

# 5. 重启服务
```

## 五、关键技术决策

### 5.1 为什么选择Repository模式?
- 数据访问逻辑集中管理
- 便于单元测试(可mock)
- 支持多种数据库实现
- 降低迁移成本

### 5.2 为什么密码使用SHA256而非bcrypt?
- 保持与现有系统一致
- 性能更好(对于高并发场景)
- 已有实现稳定运行

### 5.3 为什么数据源密码使用AES加密?
- 需要解密后连接数据库
- AES对称加密性能好
- 密钥管理相对简单

### 5.4 为什么用户token过期时间不同?
- 管理员: 24小时(安全优先)
- 普通用户: 7天(体验优先)
- 可配置化,根据需求调整

## 六、验收标准

### 6.1 功能验收
- ✅ 管理员可以创建、编辑、删除用户
- ✅ 管理员可以创建、编辑、删除数据源
- ✅ 管理员可以配置表和字段映射
- ✅ 管理员可以授予/撤销用户权限
- ✅ 普通用户可以登录前端
- ✅ 普通用户只能看到授权的数据源和表
- ✅ 钉钉/飞书前端完全傻瓜化操作

### 6.2 性能验收
- ✅ 用户列表查询 < 200ms
- ✅ 数据源列表查询 < 200ms
- ✅ 权限验证 < 50ms
- ✅ 前端页面加载 < 1s

### 6.3 安全验收
- ✅ 密码加密存储
- ✅ 数据源密码加密存储
- ✅ Token过期验证
- ✅ 权限验证完整
- ✅ SQL注入防护

## 七、总结

本实现计划基于现有项目架构,采用渐进式改造策略,确保:
1. **向后兼容**: 不破坏现有功能
2. **可扩展性**: 预留数据库迁移能力
3. **安全性**: 完整的权限验证体系
4. **易用性**: 前端完全傻瓜化操作
5. **可维护性**: 清晰的分层架构

**预计总开发时间: 16-22个工作日**

**关键里程碑:**
- 第1周: 完成数据库层和服务层
- 第2周: 完成API层和管理后台前端
- 第3周: 完成钉钉/飞书前端改造和测试

建议采用敏捷开发模式,每个阶段完成后进行评审和调整。
